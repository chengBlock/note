# 1.毕设项目概要

## 1.1 背景介绍

​		在应用开发测试时的内网环境往往网络质量很好，无法获取应用或服务在真实网络环境中运行情况。**网络模拟平台就是为了用户可以在局域网模拟不同互联网网络环境，模拟不同的延迟和丢包情况。**

## 1.2 技术要求

1. 通过Netlink与内核通信，利用Linux中的流量控制机制；
2. 基于tc实现Linux网络流量控制；
3. 使用shell、python编程

## 1.3 工作流程

1. 通过网络测量，系统获取目标网络的性能指标，得出符合真实网络状况的性能参数；
2. 根据测量结果或者用户输入，设置网络损伤模拟策略；
3. 执行模块按要求实现网络损伤模拟

## 1.4 目的实现

1. 实现了一个基于Linux平台的网络损伤模拟系统；
2. 在实现模拟时延、丢包等基本功能的基础上，也实现了根据一定的网损策略进行网损模拟；
3. 当局域网中的设备访问部署了网损系统的主机时，通过配置系统，就可以模拟出在互联网上访问的效果

## 1.5 网损仪介绍

> 网损仪是一种用来进行网络损伤模拟的专业硬件。

选择使用网损仪进行网损模拟有很多优点：

1. **即插即用：**网损仪的安装对于用户来说是透明的。只需要将网损仪串联到任何网络环境中，就可以通过网损仪精确灵活地控制网络，无需调试和复杂的部署；
2. **高可靠性：**硬件实现的网损仪经过严格的测试和校准，能长期稳定工作，保证结果的可靠性；

但，**网损仪的价格较高；作为硬件，其可扩展性也受到了限制。**

## 1.6 网损模拟软件

目前，网络损伤模拟的软件解决方案有：

1. Fiddler（跨平台）

   ```bash
   Fiddler是一个应用层的HTTP代理工具，可以通过简单的配置灵活地进行限速。但其功能较为单一，只能进行限速。对于除HTTP以外的其他协议也不支持。无法对更底层地重传、丢包进行模拟。
   ```

2. Dummynet（跨平台）

   ```bash
   Dummynet可以在两个网络层之间建立管道，通过对管道的介入，实现控制带宽、延迟、丢包率等操作，功能比较齐全，但缺点是安装、配置较为复杂，命令行的使用方式也显得十分不友好。
   ```

3. Clumsy（Windows）

   ```bash
   Clumsy能实时拦截系统接收和发送的网络数据包，人为地增加延迟、篡改内容后再进行发送，或直接丢弃，从而实现了在系统层面进行网络损伤模拟。Clumsy为用户提供了一个友好的界面，使用上比较方便，安装和配置也不复杂。但其利用的是WinDivert库，只能在Windows平台上进行使用。
   ```

​        出于软件实现系统的考虑，选择在**Linux**平台上开发网络损伤模拟系统。

# 2.相关技术

> 网络损伤模拟系统主要利用了Linux内核中的流量控制机制，通过Netlink实现用户态与内核态的通信。

## 2.1 Linux内核中的流量控制

![image-20210122185839473](C:\Users\clcheng\AppData\Roaming\Typora\typora-user-images\image-20210122185839473.png)

1. 接收主机在输入接口（Input Interface）从外部链路上接收到数据包；
2. 并非所有的数据包都会被接收主机处理，通过入口策略（Ingress Policing），会丢弃一些不符合规定的数据包；
3. 符合规定的数据包输入多路分配器（Input De-Multiplexing），如果数据包的目的地址是接受主机，则将该数据包交给上层协议（TCP、UDP等）进行更深入的处理，否则直接对数据包进行转发；
4. 转发时，通过查看路由表，可以确定数据包的下一跳。本机上层协议（TCP、UDP等）产生的数据包在发送时也是要经过转发的；
5. 所有需要转发的数据包会形成一个输出队列（Output Queuing），等待输出接口（Output Interface）最终发送数据包；
6. 输出接口最终将数据包发送到外部链路。

**Linux流量控制主要是数据包在输出队列时进行处理和实现的。**

​		可以通过改变数据包的发送次序实现乱序的效果。这种处理和实现是通过三种对象进行控制的：

- Qdisc：排队规则
- Class：类别
- Filter：过滤器

​        每个网络设备都有一个输出队列，在Linux系统中，这个输出队列被称为排队规则，数据包在排队规则中排队，再经由网络设备发送出去。一个排队规则可以是简单的一个规则，也可以通过过滤器、类别实现一个复杂的排队规则。

​        **排队规则提供了一种使数据包以不同形式排队的机制。**它们可用于实现公平排队，区分服务的优先级划分，实施带宽限制，模拟网络行为等等多个方面。

## 2.2 Netlink协议

​        用户想要进行**流量控制**时，需要告知内核自己的需求，这需要用户态和内核态的通信。这主要通过Netlink Socket实现，其是一种基于Netlink协议的Linux特有的Socket。

​		为了使用Netlink协议，需要使用Netlink套接字(Socket)。套接字用于发送和接收消息的独立上下文，一个应用程序可以使用多个套接字。结构体struct nl_sock 定义了Netlink套接字和所有的相关属性。





